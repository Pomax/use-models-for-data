<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>models/model.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Fields.html">Fields</a><ul class='methods'><li data-type='method'><a href="Fields.html#.boolean">boolean</a></li><li data-type='method'><a href="Fields.html#.choice">choice</a></li><li data-type='method'><a href="Fields.html#.model">model</a></li><li data-type='method'><a href="Fields.html#.number">number</a></li><li data-type='method'><a href="Fields.html#.string">string</a></li></ul></li><li><a href="FileSystemStore.html">FileSystemStore</a><ul class='methods'><li data-type='method'><a href="FileSystemStore.html#deleteRecord">deleteRecord</a></li><li data-type='method'><a href="FileSystemStore.html#loadRecord">loadRecord</a></li><li data-type='method'><a href="FileSystemStore.html#loadSchema">loadSchema</a></li><li data-type='method'><a href="FileSystemStore.html#ready">ready</a></li><li data-type='method'><a href="FileSystemStore.html#saveMigration">saveMigration</a></li><li data-type='method'><a href="FileSystemStore.html#saveRecord">saveRecord</a></li><li data-type='method'><a href="FileSystemStore.html#saveSchema">saveSchema</a></li></ul></li><li><a href="Model.html">Model</a><ul class='methods'><li data-type='method'><a href="Model.html#.create">create</a></li><li data-type='method'><a href="Model.html#.load">load</a></li><li data-type='method'><a href="Model.html#delete">delete</a></li><li data-type='method'><a href="Model.html#get">get</a></li><li data-type='method'><a href="Model.html#reset">reset</a></li><li data-type='method'><a href="Model.html#save">save</a></li><li data-type='method'><a href="Model.html#set">set</a></li><li data-type='method'><a href="Model.html#toForm">toForm</a></li><li data-type='method'><a href="Model.html#toHTMLForm">toHTMLForm</a></li><li data-type='method'><a href="Model.html#toHTMLTable">toHTMLTable</a></li><li data-type='method'><a href="Model.html#toHTMLTableRows">toHTMLTableRows</a></li><li data-type='method'><a href="Model.html#toString">toString</a></li><li data-type='method'><a href="Model.html#toTable">toTable</a></li><li data-type='method'><a href="Model.html#toTableRows">toTableRows</a></li><li data-type='method'><a href="Model.html#updateFromSubmission">updateFromSubmission</a></li><li data-type='method'><a href="Model.html#valueOf">valueOf</a></li></ul></li><li><a href="Models.html">Models</a><ul class='methods'><li data-type='method'><a href="Models.html#.create">create</a></li><li data-type='method'><a href="Models.html#.deleteModel">deleteModel</a></li><li data-type='method'><a href="Models.html#.loadModel">loadModel</a></li><li data-type='method'><a href="Models.html#.register">register</a></li><li data-type='method'><a href="Models.html#.resetRegistrations">resetRegistrations</a></li><li data-type='method'><a href="Models.html#.saveModel">saveModel</a></li><li data-type='method'><a href="Models.html#.setStore">setStore</a></li><li data-type='method'><a href="Models.html#.useDefaultStore">useDefaultStore</a></li></ul></li><li><a href="ModelStore.html">ModelStore</a><ul class='methods'><li data-type='method'><a href="ModelStore.html#deleteRecord">deleteRecord</a></li><li data-type='method'><a href="ModelStore.html#loadRecord">loadRecord</a></li><li data-type='method'><a href="ModelStore.html#loadSchema">loadSchema</a></li><li data-type='method'><a href="ModelStore.html#ready">ready</a></li><li data-type='method'><a href="ModelStore.html#saveMigration">saveMigration</a></li><li data-type='method'><a href="ModelStore.html#saveRecord">saveRecord</a></li><li data-type='method'><a href="ModelStore.html#saveSchema">saveSchema</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="conforms.html">conforms</a><ul class='methods'><li data-type='method'><a href="conforms.html#.conforms">conforms</a></li></ul></li><li><a href="diff.html">diff</a><ul class='methods'><li data-type='method'><a href="diff.html#.apply">apply</a></li><li data-type='method'><a href="diff.html#.applyDiff">applyDiff</a></li><li data-type='method'><a href="diff.html#.create">create</a></li><li data-type='method'><a href="diff.html#.createDiff">createDiff</a></li><li data-type='method'><a href="diff.html#.makeChangeHandler">makeChangeHandler</a></li><li data-type='method'><a href="diff.html#.reverse">reverse</a></li><li data-type='method'><a href="diff.html#.reverseDiff">reverseDiff</a></li></ul></li><li><a href="equals.html">equals</a><ul class='methods'><li data-type='method'><a href="equals.html#.equals">equals</a></li></ul></li><li><a href="Errors.html">Errors</a></li><li><a href="html.html">html</a></li><li><a href="schema.html">schema</a><ul class='methods'><li data-type='method'><a href="schema.html#.createDefault">createDefault</a></li><li data-type='method'><a href="schema.html#.createValidator">createValidator</a></li><li data-type='method'><a href="schema.html#.getModelSet">getModelSet</a></li><li data-type='method'><a href="schema.html#.getRecordNameFor">getRecordNameFor</a></li><li data-type='method'><a href="schema.html#.linkSchema">linkSchema</a></li><li data-type='method'><a href="schema.html#.migrate">migrate</a></li><li data-type='method'><a href="schema.html#.migrate%255E2">migrate^2</a></li><li data-type='method'><a href="schema.html#.unlinkSchema">unlinkSchema</a></li><li data-type='method'><a href="schema.html#.validate">validate</a></li></ul></li><li><a href="tree.html">tree</a></li><li><a href="utils.html">utils</a><ul class='methods'><li data-type='method'><a href="utils.html#.sortedObjectKeys">sortedObjectKeys</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">models/model.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {
  ModelCreateWithBadData,
  ModelFromMissingData,
  DoNotUseModelConstructor,
  UndefinedKey,
  IncompleteModelSave,
  BadModelDataSubmission,
} from "../errors.js";
import { setDataFrom, sortedObjectKeys } from "./utils.js";
import * as basicSchema from "../schema/basic-js-schema.js";
import * as html from "../forms/create-html.js";
import * as tree from "../forms/create-tree.js";
import { Models, setupReferenceHandler } from "./models.js";

/**
 * &lt;p>
 * For the most part this is initially a js-schema object,
 * which gets transformed into a validation-controlled
 * data object.
 * &lt;/p>
 *
 * &lt;p>
 * This conversion has to happen after the constructor
 * finishes, which means we can't do this as part of the
 * Model class's constructor, because that finishes before
 * the full class hierarchy instantiation has finished.
 * &lt;/p>
 *
 * &lt;p>
 * As such, you never want to instantiate a model manually,
 * and always want to use either Model.create(), or
 * Model.load(), both of which fall through to the Models
 * class, which is essentially a factory class with
 * additional functionality bolted on.
 * &lt;/p>
 *
 * @hideconstructor
 */
export class Model {
  /**
   * We don't want folks to call new Model(), so we make sure that
   * there's a few required arguments that library code uses,
   * but folks won't know to use themselves, giving them a nice
   * error that tells them to use Model.create or Model.from instead.
   */
  constructor(caller, when) {
    if (!caller || typeof when !== "number") {
      const { name } = this.__proto__.constructor;
      throw new DoNotUseModelConstructor(name);
    }
  }

  /**
   * &lt;p>This symbol can be used to create models with missing
   * "required" fields. Note that this value is inherited,
   * and so can be referenced from your own model's name
   * rather than using Model.ALLOW_INCOMPLETE.&lt;/p>
   *
   * &lt;p>E.g.&lt;/p>
   *
   * &lt;pre>&lt;code>
   *   class Something extends Model {
   *     // ...
   *   }
   *
   *   Something.create(undefined, Something.ALLOW_INCOMPLETE);
   * &lt;/code>&lt;/pre>
   */
  static ALLOW_INCOMPLETE = Symbol();

  /**
   * &lt;p>Create an instance of this model, with an optional data
   * object that will be used to bootstrap the model's fields.&lt;/p>
   *
   * &lt;p>Note that this data must be schema-conformant for this model,
   * or this function will throw.&lt;/p>
   *
   * &lt;p>If a backend store is used, this function will run &lt;code>async&lt;/code>,
   * returning a &lt;code>Promise&lt;/code> that can be &lt;code>await&lt;/code>ed,
   * or handled with &lt;code>.then()&lt;/code>&lt;/p>
   *
   * &lt;p>When no backend is used, this function will run synchronously.&lt;/p>
   *
   * @param {Symbol} [allowIncomplete] - allows models to be created without specifying all required data, if set to {@link Model.ALLOW_INCOMPLETE}.
   * @returns {Model} an instance of this model
   * @throws See {@link Models.create} for pass-through throws.
   */
  static create(data, allowIncomplete) {
    if (typeof data === `symbol`) {
      allowIncomplete = data;
      data = undefined;
    }
    if (data !== undefined &amp;&amp; typeof data !== `object`) {
      throw new ModelCreateWithBadData(this.name);
    }
    return Models.create(
      this,
      data,
      allowIncomplete === Model.ALLOW_INCOMPLETE
    );
  }

  /**
   * &lt;p>Load a stored record that uses this model from the back end.&lt;/p>
   *
   * &lt;p>Note that this will throw if:&lt;/p>
   *
   * &lt;ul>
   *  &lt;li>there is no stored record to load&lt;/li>
   *  &lt;li>the stored record is not valid JSON&lt;/li>
   *  &lt;li>the stored record is not schema-conformant&lt;/li>
   * &lt;/ul>
   *
   * @param {*} recordName
   * @returns {*} a stored model instance
   * @throws {*} one of several errors
   */
  static async load(recordName) {
    return Models.loadModel(this, recordName);
  }

  /**
   * &lt;p>Save this model instance to the backend. Note that this
   * requires the model class to specify a &lt;code>__meta.recordName&lt;/code>
   * field, which must indicate which key path to use as
   * "primary key" equivalent, or be a function that, given a
   * model, yields a string to be used as record key.&lt;/p>
   *
   * @throws {*} one of several errors
   */
  async save() {
    let errors;
    if (this.__incomplete) {
      const schema = this.__proto__.constructor.schema;
      const result = basicSchema.validate(schema, this);
      if (result.passed) {
        delete this.__incomplete;
      } else {
        errors = result.errors;
      }
    }
    if (!this.__incomplete) {
      return Models.saveModel(this);
    } else {
      const { name } = this.__proto__.constructor;
      throw new IncompleteModelSave(name, errors);
    }
  }

  /**
   * &lt;p>Delete this model from the backend.&lt;/p>
   *
   * @throws {*} one of several errors
   */
  async delete() {
    return Models.deleteModel(this);
  }

  /**
   * get a value by pathkey, rather than direct assignment
   *
   * @param {*} pathkey
   * @return {*} the pathkey-associated value
   */
  get(pathkey) {
    return getSetLevel(this, pathkey);
  }

  /**
   * set a value by pathkey, rather than direct assignment
   *
   * @param {*} pathkey
   * @param {*} value
   */
  set(pathkey, value) {
    getSetLevel(this, pathkey, value);
  }

  /**
   * &lt;p>Update this model from a form submission, or any data payload
   * that encodes the model data using a flat &lt;keypath>:&lt;string>
   * format, e.g. a format which encodes this object:&lt;/p>
   *
   * &lt;pre>&lt;code>
   * {
   *   prop1: val1,
   *   prop2: {
   *     prop3: val2,
   *     prop4: {
   *       prop5: val3
   *     }
   *   }
   * }
   * &lt;/code>&lt;/pre>
   *
   * &lt;p>as this flat object:&lt;/p>
   *
   * &lt;pre>&lt;code>
   * {
   *   "prop1": "val1",
   *   "prop2.prop3": "val2",
   *   "prop2.prop4.prop5": "val3",
   * }
   * &lt;/code>&lt;/pre>
   *
   * @param {*} data
   * @throws {*} one of several errors
   */
  updateFromSubmission(data) {
    const Model = this.__proto__.constructor;
    const schema = Model.schema;
    const strictValidation = false; // we want the data to be coerced during validation
    const result = basicSchema.validate(schema, data, strictValidation);
    if (result.passed) return setDataFrom(data, this);

    // If we get here, there were problems, so let's be super clear about that and throw.
    throw new BadModelDataSubmission(Model.name, result.errors);
  }

  /**
   * Recursively reset this model to default values, for any
   * value that has a default set in its associated schema.
   *
   * @param {*} postResetPayload the data with which to bootstrap this model after resetting.
   */
  reset(postResetPayload) {
    Object.entries(this).forEach(([key, value]) => {
      const schema = this.__proto__.constructor.schema;
      if (value instanceof Model) {
        value.reset();
      } else {
        // Always try default value first
        if (schema[key].default) {
          this[key] = schema[key].default;
        }
        // If there's no default, and this field is not
        // required, we reset the field to its original
        // proxied getter/setter declaration.
        else if (!schema[key].__meta.required) {
          setupReferenceHandler(this, key, schema);
        }
        // If neither of those apply, then we can't
        // reset this value, and it stays what it is.
      }
    });

    if (postResetPayload) setDataFrom(postResetPayload, this);
  }

  // Form builders: plain HTML

  /**
   * Generate a &amp;lt;form&amp;gt; element for viewing/updating this model.
   * See {@link html.createFormHTML} for details on what the
   * available &lt;code>options&lt;/code> are.
   *
   * @param {object} options - a configuration object
   * @returns {String} form HTML string data
   * @see html.createFormHTML
   */
  toHTMLForm(options) {
    const schema = this.__proto__.constructor.schema;
    return html.createFormHTML(schema, this, options);
  }

  /**
   * Generate a &amp;lt;table&amp;gt; with form fields for this model.
   * See {@link html.createTableHTML} for details on what the
   * available &lt;code>options&lt;/code> are.
   *
   * @param {object} options - a configuration object
   * @returns {String} table HTML string data
   * @see html.createTableHTML
   */
  toHTMLTable(options) {
    const schema = this.__proto__.constructor.schema;
    return html.createTableHTML(schema, this, options);
  }

  /**
   * Generate an array of &amp;lt;tr&amp;gt; elements with form fields for this model.
   * See {@link html.createTableRowHTML} for details on what the
   * available &lt;code>options&lt;/code> are.
   *
   * @param {object} options - a configuration object
   * @returns {String} table rows HTML string data
   * @see html.createTableRowHTML
   */
  toHTMLTableRows(options) {
    const schema = this.__proto__.constructor.schema;
    return html.createTableRowHTML(schema, this, options);
  }

  // Form builders: Tree based data

  /**
   * &lt;p>
   * Generate a node tree for working with this model's data
   * in some non-HTML context. By default, this yields the
   * (P)React equivalent of a &amp;lt;form&amp;gt;, with options.onSubmit
   * being used for submission handling.
   * &lt;/p>
   *
   * &lt;p>
   * See {@link tree.createFormTree} for details on what the
   * available &lt;code>options&lt;/code> are.
   * &lt;/p>
   *
   * @param {object} options - a configuration object
   * @returns {*} a JS object tree representing a form
   * @see tree.createFormTree
   */
  toForm(options = {}) {
    const schema = this.__proto__.constructor.schema;
    return tree.createFormTree(schema, this, options);
  }

  /**
   * &lt;p>
   * Generate a node tree for working with this model's data
   * in some non-HTML context. By default, this yields the
   * (P)React equivalent of a &amp;lt;table&amp;gt; for templating into a
   * component render.
   * &lt;/p>
   *
   * &lt;p>
   * See {@link tree.createTableTree} for details on what the
   * available &lt;code>options&lt;/code> are.
   * &lt;/p>
   *
   * @param {object} options - a configuration object
   * @returns {*} a JS object tree representing a table
   * @see tree.createTableTree
   */
  toTable(options = {}) {
    const schema = this.__proto__.constructor.schema;
    return tree.createTableTree(schema, this, options);
  }

  /**
   * &lt;p>
   * Generate an array of table rows for working with this
   * model's data in some non-HTML context. By default, this
   * yields an array of the (P)React equivalent of &amp;lt;tr&amp;gt;,
   * for templating into a component render.
   * &lt;/p>
   *
   * &lt;p>
   * See {@link tree.createTableTree} for details on what the
   * available &lt;code>options&lt;/code> are.
   * &lt;/p>
   *
   * @param {object} options - a configuration object
   * @returns {*} a JS array representing a set of table rows
   * @see tree.createTableTreeRows
   */
  toTableRows(options = {}) {
    const schema = this.__proto__.constructor.schema;
    return tree.createTableTreeRows(schema, this, options);
  }

  /**
   * Yield a fully qualified plain object, with default values included.
   *
   * @returns {*} a plain JS object
   */
  valueOf() {
    const process = (model, output) => {
      const Model = model.__proto__.constructor;
      Object.entries(Model.schema).forEach(([key, value]) => {
        if (key === `__meta`) return;
        if (value.shape) {
          output[key] = {};
          return process(model[key], output[key]);
        }
        output[key] = model[key];
      });
      return output;
    };
    return process(this, {});
  }

  /**
   * Yield formatted JSON, with alphabetically sorted keys,
   * with all defaults omitted (as they are not enumerable).
   *
   * @returns {*} a JSON string with sorted keys
   */
  toString() {
    return JSON.stringify(this, sortedObjectKeys, 2);
  }
}

/**
 * @ignore
 */
function testLevel(model, level, pathkey, terms) {
  const term = terms.shift();
  if (level[term] === undefined) {
    const { name } = model.__proto__.constructor;
    throw new UndefinedKey(pathkey, name);
  }
  return term;
}

/**
 * @ignore
 */
function getSetLevel(model, pathkey, value) {
  const terms = pathkey.split(`.`);
  let level = model;
  const getTerm = () => testLevel(model, level, pathkey, terms);
  while (terms.length > 1) level = level[getTerm()];
  const term = getTerm();
  if (value !== undefined) {
    level[term] = value;
  }
  return level[term];
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Thu Nov 11 2021 18:07:30 GMT-0800 (Pacific Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
