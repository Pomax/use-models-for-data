<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>models/fields.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Fields.html">Fields</a><ul class='methods'><li data-type='method'><a href="Fields.html#.boolean">boolean</a></li><li data-type='method'><a href="Fields.html#.choice">choice</a></li><li data-type='method'><a href="Fields.html#.model">model</a></li><li data-type='method'><a href="Fields.html#.number">number</a></li><li data-type='method'><a href="Fields.html#.string">string</a></li></ul></li><li><a href="FileSystemStore.html">FileSystemStore</a><ul class='methods'><li data-type='method'><a href="FileSystemStore.html#deleteRecord">deleteRecord</a></li><li data-type='method'><a href="FileSystemStore.html#loadRecord">loadRecord</a></li><li data-type='method'><a href="FileSystemStore.html#loadSchema">loadSchema</a></li><li data-type='method'><a href="FileSystemStore.html#ready">ready</a></li><li data-type='method'><a href="FileSystemStore.html#saveMigration">saveMigration</a></li><li data-type='method'><a href="FileSystemStore.html#saveRecord">saveRecord</a></li><li data-type='method'><a href="FileSystemStore.html#saveSchema">saveSchema</a></li></ul></li><li><a href="Model.html">Model</a><ul class='methods'><li data-type='method'><a href="Model.html#.create">create</a></li><li data-type='method'><a href="Model.html#.from">from</a></li><li data-type='method'><a href="Model.html#.load">load</a></li><li data-type='method'><a href="Model.html#delete">delete</a></li><li data-type='method'><a href="Model.html#get">get</a></li><li data-type='method'><a href="Model.html#reset">reset</a></li><li data-type='method'><a href="Model.html#save">save</a></li><li data-type='method'><a href="Model.html#set">set</a></li><li data-type='method'><a href="Model.html#toForm">toForm</a></li><li data-type='method'><a href="Model.html#toHTMLForm">toHTMLForm</a></li><li data-type='method'><a href="Model.html#toHTMLTable">toHTMLTable</a></li><li data-type='method'><a href="Model.html#toHTMLTableRows">toHTMLTableRows</a></li><li data-type='method'><a href="Model.html#toString">toString</a></li><li data-type='method'><a href="Model.html#toTable">toTable</a></li><li data-type='method'><a href="Model.html#toTableRows">toTableRows</a></li><li data-type='method'><a href="Model.html#updateFromSubmission">updateFromSubmission</a></li><li data-type='method'><a href="Model.html#valueOf">valueOf</a></li></ul></li><li><a href="Models.html">Models</a><ul class='methods'><li data-type='method'><a href="Models.html#.create">create</a></li><li data-type='method'><a href="Models.html#.deleteModel">deleteModel</a></li><li data-type='method'><a href="Models.html#.loadModel">loadModel</a></li><li data-type='method'><a href="Models.html#.register">register</a></li><li data-type='method'><a href="Models.html#.resetRegistrations">resetRegistrations</a></li><li data-type='method'><a href="Models.html#.saveModel">saveModel</a></li><li data-type='method'><a href="Models.html#.setStore">setStore</a></li><li data-type='method'><a href="Models.html#.useDefaultStore">useDefaultStore</a></li></ul></li><li><a href="ModelStore.html">ModelStore</a><ul class='methods'><li data-type='method'><a href="ModelStore.html#deleteRecord">deleteRecord</a></li><li data-type='method'><a href="ModelStore.html#loadRecord">loadRecord</a></li><li data-type='method'><a href="ModelStore.html#loadSchema">loadSchema</a></li><li data-type='method'><a href="ModelStore.html#ready">ready</a></li><li data-type='method'><a href="ModelStore.html#saveMigration">saveMigration</a></li><li data-type='method'><a href="ModelStore.html#saveRecord">saveRecord</a></li><li data-type='method'><a href="ModelStore.html#saveSchema">saveSchema</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="conforms.html">conforms</a><ul class='methods'><li data-type='method'><a href="conforms.html#.conforms">conforms</a></li></ul></li><li><a href="diff.html">diff</a><ul class='methods'><li data-type='method'><a href="diff.html#.apply">apply</a></li><li data-type='method'><a href="diff.html#.applyDiff">applyDiff</a></li><li data-type='method'><a href="diff.html#.create">create</a></li><li data-type='method'><a href="diff.html#.createDiff">createDiff</a></li><li data-type='method'><a href="diff.html#.makeChangeHandler">makeChangeHandler</a></li><li data-type='method'><a href="diff.html#.reverse">reverse</a></li><li data-type='method'><a href="diff.html#.reverseDiff">reverseDiff</a></li></ul></li><li><a href="equals.html">equals</a><ul class='methods'><li data-type='method'><a href="equals.html#.equals">equals</a></li></ul></li><li><a href="Errors.html">Errors</a></li><li><a href="html.html">html</a></li><li><a href="schema.html">schema</a><ul class='methods'><li data-type='method'><a href="schema.html#.createDefault">createDefault</a></li><li data-type='method'><a href="schema.html#.createValidator">createValidator</a></li><li data-type='method'><a href="schema.html#.getModelSet">getModelSet</a></li><li data-type='method'><a href="schema.html#.getRecordNameFor">getRecordNameFor</a></li><li data-type='method'><a href="schema.html#.linkSchema">linkSchema</a></li><li data-type='method'><a href="schema.html#.migrate">migrate</a></li><li data-type='method'><a href="schema.html#.migrate%255E2">migrate^2</a></li><li data-type='method'><a href="schema.html#.unlinkSchema">unlinkSchema</a></li><li data-type='method'><a href="schema.html#.validate">validate</a></li></ul></li><li><a href="tree.html">tree</a></li><li><a href="utils.html">utils</a><ul class='methods'><li data-type='method'><a href="utils.html#.sortedObjectKeys">sortedObjectKeys</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">models/fields.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {
  MissingChoicesArray,
  TypeNotMatchedToChoices,
  FieldFailedCustomValidation,
} from "../errors.js";
import { setDataFrom } from "./utils.js";
import * as basicSchema from "../schema/basic-js-schema.js";

/**
 * Generate correctly typed model fields, in the sense
 * that they are of a form that js-schema can work with.
 *
 * @ignore
 */
class ModelField {
  /**
   * Construct a model field object, with unpacked options,
   * mimicking a schema definition that matches what the
   * basic-js-schema code works with.
   *
   * @constructor
   * @param {Object} options - an options object.
   * @ignore
   */
  constructor(options = {}) {
    const defaultValue = options.default;
    const { type, choices, shape, ...rest } = options;
    delete rest.default;

    this.__meta = {};

    if (shape?.__meta) {
      this.__meta = shape.__meta;
      delete shape.__meta;
    }

    setDataFrom(rest, this.__meta);

    if (type !== undefined) this.type = type;
    if (defaultValue !== undefined) this.default = defaultValue;
    if (choices !== undefined) this.choices = choices;
    if (shape !== undefined) this.shape = shape;
  }
}

/**
 * &lt;p>Static model field builder.&lt;/p>
 *
 * &lt;p>&lt;strong>note&lt;/strong>: "one-or-more" is handled as `array: true`
 * in the options, rather than being its own type of model field. (On
 * the schema side this is the __meta.array:true property)&lt;/p>
 *
 * &lt;p>All fields can be passed an options object that supports arbitrary
 * keywords, with some exceptions that are used by the schema system
 * itself:&lt;/p>
 *
 * &lt;pre>&lt;code>
 *   {
 *     required: boolean,
 *     default: any value,
 *     choices: array of possible values,
 *     configurable: boolean,
 *     debug: boolean,
 *   }
 * &lt;/code>&lt;/pre>
 *
 * @class
 * @hideconstructor
 */
export class Fields {
  /**
   * Model field definition for boolean values.
   *
   * @param {Object} options - an options object, see above.
   * @returns {ModelField}
   */
  static boolean(options = {}) {
    return new ModelField({ type: `boolean`, ...options });
  }

  /**
   *
   * @param {Object} options - an options object, see above.
   * @returns {ModelField}
   */
  static string(options = {}) {
    const type = `string`;
    testChoiceDefault(type, options);
    return new ModelField({ type, ...options });
  }

  /**
   *
   * @param {Object} options - an options object, see above.
   * @returns {ModelField}
   */
  static number(options = {}) {
    const type = `number`;
    testChoiceDefault(type, options);
    return new ModelField({ type, ...options });
  }

  /**
   *
   * @param {any[]} choices - Array of valid values for this field.
   * @param {Object} options - an options object, see above.
   * @returns {ModelField}
   */
  static choice(choices, options = {}) {
    if (choices === undefined || !(choices instanceof Array)) {
      throw new MissingChoicesArray();
    }
    return new ModelField({ type: undefined, choices, ...options });
  }

  /**
   *
   * @param {Model} model
   * @param {Object} options - an options object, see above.
   * @returns {ModelField}
   */
  static model(Model, options = {}) {
    return new ModelField({ shape: new Model(this, Date.now()), ...options });
  }
}

/**
 * @ignore
 * @param {*} type
 * @param {Object} options - an options object, see above.
 */
function testChoiceDefault(type, options) {
  const v = options.default;
  if (v !== undefined &amp;&amp; options.choices) {
    if (typeof v !== type &amp;&amp; !options.choices.includes(v)) {
      throw new TypeNotMatchedToChoices(type);
    }
  }
}

/**
 * Validate a model field
 *
 * @param {*} key
 * @param {*} value
 * @param {*} definition
 * @param {*} strict
 * @returns {boolean} True is this key/value pair passed validation, false if it didn't. Note that the value may have been rewritten to fit the correct type if &lt;code>strict=false&lt;/code> was used.
 * @ignore
 */
export function validate(key, value, definition, strict = false) {
  const schema = {
    [key]: {
      __meta: definition.__meta,
      type: definition.type,
      default: definition.default,
    },
  };

  [`choices`].forEach((k) => {
    const v = definition[k];
    if (v !== undefined) schema[key][k] = v;
  });

  const customValidate = definition.__meta.validate;
  const basic = basicSchema.validate(schema, { [key]: value }, strict);
  if (!customValidate || !basic.passed) return basic;

  try {
    if (customValidate(value) === false) {
      throw new FieldFailedCustomValidation(key);
    }
    return { passed: true };
  } catch (err) {
    return { passed: false, errors: [err.message] };
  }
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Wed Nov 03 2021 16:01:34 GMT-0700 (Pacific Daylight Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
