<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>forms/create-tree.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="DummyStore.html">DummyStore</a></li><li><a href="Fields.html">Fields</a><ul class='methods'><li data-type='method'><a href="Fields.html#.boolean">boolean</a></li><li data-type='method'><a href="Fields.html#.choice">choice</a></li><li data-type='method'><a href="Fields.html#.model">model</a></li><li data-type='method'><a href="Fields.html#.number">number</a></li><li data-type='method'><a href="Fields.html#.string">string</a></li></ul></li><li><a href="FileSystemStore.html">FileSystemStore</a><ul class='methods'><li data-type='method'><a href="FileSystemStore.html#deleteRecord">deleteRecord</a></li><li data-type='method'><a href="FileSystemStore.html#loadRecord">loadRecord</a></li><li data-type='method'><a href="FileSystemStore.html#loadSchema">loadSchema</a></li><li data-type='method'><a href="FileSystemStore.html#ready">ready</a></li><li data-type='method'><a href="FileSystemStore.html#saveMigration">saveMigration</a></li><li data-type='method'><a href="FileSystemStore.html#saveRecord">saveRecord</a></li><li data-type='method'><a href="FileSystemStore.html#saveSchema">saveSchema</a></li></ul></li><li><a href="Model.html">Model</a><ul class='methods'><li data-type='method'><a href="Model.html#.create">create</a></li><li data-type='method'><a href="Model.html#.load">load</a></li><li data-type='method'><a href="Model.html#delete">delete</a></li><li data-type='method'><a href="Model.html#get">get</a></li><li data-type='method'><a href="Model.html#reset">reset</a></li><li data-type='method'><a href="Model.html#save">save</a></li><li data-type='method'><a href="Model.html#set">set</a></li><li data-type='method'><a href="Model.html#toForm">toForm</a></li><li data-type='method'><a href="Model.html#toHTMLForm">toHTMLForm</a></li><li data-type='method'><a href="Model.html#toHTMLTable">toHTMLTable</a></li><li data-type='method'><a href="Model.html#toHTMLTableRows">toHTMLTableRows</a></li><li data-type='method'><a href="Model.html#toString">toString</a></li><li data-type='method'><a href="Model.html#toTable">toTable</a></li><li data-type='method'><a href="Model.html#toTableRows">toTableRows</a></li><li data-type='method'><a href="Model.html#updateFromSubmission">updateFromSubmission</a></li><li data-type='method'><a href="Model.html#valueOf">valueOf</a></li></ul></li><li><a href="Models.html">Models</a><ul class='methods'><li data-type='method'><a href="Models.html#.create">create</a></li><li data-type='method'><a href="Models.html#.deleteModel">deleteModel</a></li><li data-type='method'><a href="Models.html#.loadModel">loadModel</a></li><li data-type='method'><a href="Models.html#.register">register</a></li><li data-type='method'><a href="Models.html#.resetRegistrations">resetRegistrations</a></li><li data-type='method'><a href="Models.html#.saveModel">saveModel</a></li><li data-type='method'><a href="Models.html#.setStore">setStore</a></li><li data-type='method'><a href="Models.html#.useDefaultStore">useDefaultStore</a></li></ul></li><li><a href="ModelStore.html">ModelStore</a><ul class='methods'><li data-type='method'><a href="ModelStore.html#deleteRecord">deleteRecord</a></li><li data-type='method'><a href="ModelStore.html#loadRecord">loadRecord</a></li><li data-type='method'><a href="ModelStore.html#loadSchema">loadSchema</a></li><li data-type='method'><a href="ModelStore.html#ready">ready</a></li><li data-type='method'><a href="ModelStore.html#saveMigration">saveMigration</a></li><li data-type='method'><a href="ModelStore.html#saveRecord">saveRecord</a></li><li data-type='method'><a href="ModelStore.html#saveSchema">saveSchema</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="conforms.html">conforms</a><ul class='methods'><li data-type='method'><a href="conforms.html#.conforms">conforms</a></li></ul></li><li><a href="diff.html">diff</a><ul class='methods'><li data-type='method'><a href="diff.html#.apply">apply</a></li><li data-type='method'><a href="diff.html#.applyDiff">applyDiff</a></li><li data-type='method'><a href="diff.html#.create">create</a></li><li data-type='method'><a href="diff.html#.createDiff">createDiff</a></li><li data-type='method'><a href="diff.html#.makeChangeHandler">makeChangeHandler</a></li><li data-type='method'><a href="diff.html#.reverse">reverse</a></li><li data-type='method'><a href="diff.html#.reverseDiff">reverseDiff</a></li></ul></li><li><a href="equals.html">equals</a><ul class='methods'><li data-type='method'><a href="equals.html#.equals">equals</a></li></ul></li><li><a href="Errors.html">Errors</a></li><li><a href="html.html">html</a></li><li><a href="schema.html">schema</a><ul class='methods'><li data-type='method'><a href="schema.html#.createDefault">createDefault</a></li><li data-type='method'><a href="schema.html#.createValidator">createValidator</a></li><li data-type='method'><a href="schema.html#.getModelSet">getModelSet</a></li><li data-type='method'><a href="schema.html#.getRecordNameFor">getRecordNameFor</a></li><li data-type='method'><a href="schema.html#.linkSchema">linkSchema</a></li><li data-type='method'><a href="schema.html#.migrate">migrate</a></li><li data-type='method'><a href="schema.html#.migrate%255E2">migrate^2</a></li><li data-type='method'><a href="schema.html#.unlinkSchema">unlinkSchema</a></li><li data-type='method'><a href="schema.html#.validate">validate</a></li></ul></li><li><a href="tree.html">tree</a></li><li><a href="utils.html">utils</a><ul class='methods'><li data-type='method'><a href="utils.html#.sortedObjectKeys">sortedObjectKeys</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#processFormTreeField">processFormTreeField</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">forms/create-tree.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @namespace tree
 */

import labelFunction from "./label-function.js";
import { getCreateFunction, __appendChildNode } from "./tree-helpers.js";

/**
 * &lt;p>
 * similar to {@link html.createFormHTML}, except we're not building an
 * HTML string, we're building a DOM-like (e.g. (P)React) tree of content.
 * &lt;/p>
 *
 * &lt;p>
 * The options object should take the following form:
 * &lt;/p>
 *
 * &lt;pre>&lt;code>
 *   {
 *     create: function,
 *     footer: string,
 *     label: function,
 *     skipDebug: boolean,
 *     disabled: boolean,
 *     inputHandler: { function },
 *   }
 * &lt;/code>&lt;/pre>
 *
 * &lt;p>
 * TODO: write the rest of the docs here, explaining how each of these options affect code generation.
 * &lt;/p>
 *
 * @name tree.createFormTree
 * @param {schema} schema - A schema definition
 * @param {object} object - A schema-conformant definition
 * @param {object} options - See above.
 * @returns {tree} a DOM-style tree representing a form tree for working with this schema'd object
 */
export function createFormTree(schema, object, options) {
  const create = (options.create = getCreateFunction(options));
  const { footer, ...otherOptions } = options;
  delete otherOptions.create;
  options.label ??= labelFunction;

  return create(`form`, {
    id: schema.__meta.name,
    ...otherOptions,
    children: [
      ...createFormTreeComponents(schema, object, options),
      footer,
    ].filter(Boolean),
  });
}

/**
 * ...DOCS GO HERE...
 */
function processFormTreeField(field_name, schema, object, options) {
  const { create, label } = options;
  const ref = object[field_name];
  const schemaEntry = schema[field_name];
  const { type, choices, shape } = schemaEntry;
  const { distinct, required, debug, configurable, description } =
    schemaEntry.__meta;

  if (!options.forceInclude) {
    if (configurable === false) return;
    if (debug === true &amp;&amp; options.skipDebug !== false) return;
  }

  const id = `${
    schema.__meta.prefix ? `${schema.__meta.prefix}.` : ``
  }${field_name}`;

  if (distinct) {
    schemaEntry.__meta.prefix = id;
    return create(`fieldset`, {
      id: id,
      children: [...createFormTreeComponents(schemaEntry, ref, options)].flat(),
    });
  }

  if (shape) {
    if (!shape.__meta) {
      shape.__meta = {};
    }
    shape.__meta.prefix = id;

    // DIFFERENCE COMPARED TO createTableTreeRows STARTS HERE
    return create(`fieldset`, {
      id: id,
      children: [...createFormTreeComponents(shape, ref, options)].flat(),
    });
  }

  const fieldElements = [
    create(`label`, { for: id, children: [label(field_name)] }),
  ];

  __appendChildNode(
    fieldElements,
    create,
    id,
    choices,
    type,
    ref,
    required,
    options.disabled,
    options.inputHandler
  );

  const children = [
    create(`span`, { children: fieldElements, class: `form-element` }),
  ];

  if (options.descriptions) {
    children.push(create(`p`, { children: [description] }));
  }

  const div = create(`div`, { children });

  // END OF DIFFERENCE COMPARED TO createTableTreeRots

  return div;
}

function createFormTreeComponents(schema, object, options) {
  const { create, label } = options;

  // is this a "base" shaped model? If so, write it back up as a schema.
  if (schema.shape) {
    const __meta = schema.__meta;
    schema = schema.shape;
    schema.__meta = __meta;
  }

  const { __meta } = schema;
  if (__meta.form) {
    return [
      __meta.form[0].heading
        ? undefined
        : create(`h2`, {
            children: [schema.__meta.name || schema.__proto__.constructor.name],
            class: `model-name`,
          }),
      ...__meta.form.map((entry) => {
        const { descriptions, fields, heading, collapsed, controls } = entry;
        let { collapsible } = entry;
        const preamble = [];

        if (heading) {
          const headingid = heading
            .replace(/\W/g, `-`)
            .replace(/--+/g, `-`)
            .toLowerCase();
          collapsible = collapsible || collapsed;

          preamble.push(
            create(`label`, {
              children: [heading],
              for: `check-${headingid}`,
              class: `heading ${collapsible ? `collapsible` : ``}`.trim(),
            })
          );

          if (collapsible) {
            preamble.push(
              create(`input`, {
                type: `checkbox`,
                id: `check-${headingid}`,
                class: `heading-collapse`,
                checked: collapsed,
              }),
              create(`span`, { class: `heading-collapse` })
            );
          }
        }

        const allFields = fields
          .map((field_name) =>
            processFormTreeField(field_name, schema, object, {
              ...options,
              forceInclude: true,
              descriptions: descriptions !== false,
            })
          )
          .filter(Boolean);

        return allFields.length
          ? create(`fieldset`, {
              children: [
                ...preamble,
                ...allFields.flat(),
                controls
                  ? create(`div`, {
                      class: `controls`,
                      children: [
                        create(`button`, {
                          type: `submit`,
                          children: [controls.save],
                        }),
                        create(`button`, {
                          type: `reset`,
                          children: [controls.cancel],
                        }),
                      ],
                    })
                  : undefined,
              ],
            })
          : undefined;
      }),
    ];
  }

  return [
    create(`h2`, {
      children: [schema.__meta.name || schema.__proto__.constructor.name],
      class: `model-name`,
    }),
    ...Object.keys(schema)
      .filter((v) => v !== `__meta`)
      .map((field_name) =>
        processFormTreeField(field_name, schema, object, options)
      ),
  ].filter(Boolean);
}

/**
 * &lt;p>
 * similar to {@link html.createTableHTML}, except we're not building an
 * HTML string, we're building a DOM-like (e.g. (P)React) tree of content.
 * &lt;/p>
 *
 * @name tree.createFormTreeComponents
 * @param {schema} schema - A schema definition
 * @param {object} object - A schema-conformant definition
 * @param {object} options - See above.
 * @returns {tree} a DOM-style tree representing a table for working with this schema'd object
 */
export function createTableTree(schema, object, options) {
  const create = getCreateFunction(options);
  const { footer, ...otherOptions } = options;
  delete otherOptions.create;

  return create(`table`, {
    id: schema.__meta?.name,
    ...otherOptions,
    children: [
      ...createTableTreeRows(schema, object, options),
      options.footer,
    ].filter(Boolean),
  });
}

function processTableTreeField(field_name, schema, object, options) {
  const { create, label } = options;
  const ref = object ? object[field_name] : undefined;
  const schemaEntry = schema[field_name];
  const { type, choices, shape } = schemaEntry;
  const { distinct, required, debug, configurable, description } =
    schemaEntry.__meta;

  if (!options.forceInclude) {
    if (configurable === false) return;
    if (debug === true &amp;&amp; options.skipDebug !== false) return;
  }

  const id = `${
    schema.__meta?.prefix ? `${schema.__meta.prefix}.` : ``
  }${field_name}`;

  if (distinct) {
    schemaEntry.__meta.prefix = id;
    return createTableTreeRows(schemaEntry, ref, options).flat();
  }

  if (shape) {
    if (!shape.__meta) {
      shape.__meta = {};
    }
    shape.__meta.prefix = id;
    const subfields = createTableTreeRows(shape, ref, options);
    if (subfields.length === 0) return [];
    return [
      create(`tr`, {
        children: [create(`td`, { colspan: 2, children: [label(field_name)] })],
      }),
      ...subfields,
    ];
  }

  const row = create(`tr`, {
    children: [
      create(`td`, { title: description, children: [label(field_name)] }),
      create(`td`, {
        children: __appendChildNode(
          [],
          create,
          id,
          choices,
          type,
          ref !== undefined ? ref : schemaEntry.default,
          required,
          options.disabled,
          options.inputHandler
        ),
      }),
    ],
  });

  return row;
}

/**
 * &lt;p>
 * similar to {@link html.createTableRowHTML}, except we're not building an
 * HTML string, we're building am array of DOM-like (e.g. (P)React) nods, mapping
 * to table rows.
 * &lt;/p>
 *
 * @name tree.createTableTreeRows
 * @param {schema} schema - A schema definition
 * @param {object} object - A schema-conformant definition
 * @param {object} options - See above.
 * @returns {node[]} a set of DOM-style nodes representing table rows for working with this schema'd object
 */
export function createTableTreeRows(schema, object, options) {
  options.create = getCreateFunction(options);
  options.label ??= labelFunction;

  // is this a "base" shaped model? If so, write it back up as a schema.
  if (schema.shape) {
    const __meta = schema.__meta;
    schema = schema.shape;
    schema.__meta = __meta;
  }

  const { __meta } = schema;
  if (__meta.form) {
    return __meta.form
      .map((entry) => {
        const { header, collapsible, collapsed, descriptions, fields } = entry;
        return fields
          .map((field_name) =>
            processTableTreeField(field_name, schema, object, {
              ...options,
              forceInclude: true,
              descriptions: descriptions !== false,
            })
          )
          .filter(Boolean)
          .flat();
      })
      .flat();
  }

  return Object.keys(schema)
    .filter((v) => v !== `__meta`)
    .map((field_name) =>
      processTableTreeField(field_name, schema, object, options)
    )
    .filter(Boolean)
    .flat();
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Wed Dec 29 2021 10:36:58 GMT-0800 (Pacific Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
