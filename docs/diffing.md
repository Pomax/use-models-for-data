# JS diff API

Ever needed a way to diff two JS data objects? Not "a text diff between two JSON strings", but an actual diff between two live, in-memory objects, that you can then apply in a way that preserves references even if key/value pairs move around?

Then you probably need this.

## Creating a diff

 `create(object1, object2)` / `createDiff(object1, object2)`

Create a diff between two objects, yielding an array of operations that can be any of:

### addition

```js
{
    type: "add",
    key: "dot-separated key path",
    value: "value for this key",
}
```

### updates

```js
{
    type: "update",
    key: "dot-separated key path",
    value: "new value for key",
}
```


### renames

```js
{
    type: "rename",
    oldKey: "dot-separated original key path",
    newKey: "dot-separated new key path",
}
```

### relocations

```js
{
    type: "move",
    oldKey: "dot-separated original key path",
    newKey: "dot-separated new key path",
}
```

### removal

```js
{
    type: "remove",
    key: "dot-separated key path",
}
```



## `apply(diff, object)` / `applyDiff(diff, object)`

Applies an array of operations (as generated by `create`) to an object.

## `apply(diff, object, changeHandler)` / `applyDiff(diff, object, changeHandler)`

Applies an array of operations as generated by `create` to an object, by running it through the `changeHandler` function as:

```js
function apply(operations, object, changeHandler) {
  operations.forEach((op) => {
    changeHandler(object, op);
    if (changeHandler[op.fn] !== undefined) {
      changeHandler[op.fn](object, op);
    }
  });
  return object;
}
```

That is, the changeHandler knows how to apply the diffs, rather than the `apply` function itself.

Why would you want this? Three-way diffs! Read on.

## `makeChangeHandler(ignoreKey, filterKeyString)`

In order to perform three-way diffing, such as when you have two JS schemas, create a diff between the two, and then way to apply that diff to _instances_ of those schema, rather than schema themselves, this can be fairly trivially achieved using a changeHandler:

```js
function makeSchemaChangeHandler() {
  return makeChangeHandler(ignoreKey, filterKeyString);
}

function ignoreKey(key, _type) {
  if (key.includes(`__meta`)) return true;
  if (key.includes(`.default`)) return true;
  if (key.includes(`.choices`)) return true;
}

function filterKeyString(key) {
  return key.replaceAll(`.shape`, ``);
}
```

With just this, we can apply a schema diff to objects:

```js
const schemaDiff = diff(schema1, schema2);
const schemaChangeHandler = makeSchemaChangeHandler();
const schema2conformant = schema1conformant.map(obj => apply(schemaDiff, obj, schemaChangeHandler));
```

And done, instead of using the diff to turn `schema1` into `schema2`, we're using the diff to guide the transformation of "third objects" instead. That's powerful.

### ignoreKey(key, type)

The `ignoreKey` function is used to determine whether to process a diff for a specific key at all. For regular diffs this will be true, but for three-way diffs, this is most certainly not always the case.

### filterKeyString(key)

The `filterKeyString` function is used to "sanitize" keys in order to make sure that they match the `apply` target. Again, for regular diffs this won't matter, but for three-way diffs it is hugely important.
